<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Psmm : PSeudo-Mutable Message for Actors">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Psmm</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/cuzfrog/psmm">View on GitHub</a>

          <h1 id="project_title">Psmm</h1>
          <h2 id="project_tagline">PSeudo-Mutable Message for Actors</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/cuzfrog/psmm/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/cuzfrog/psmm/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h2>
<a id="project-developing-progress" class="anchor" href="#project-developing-progress" aria-hidden="true"><span class="octicon octicon-link"></span></a>Project developing progress:</h2>

<p>General tests passed, so far actors work fine, but there are still bunch of flaws. Now I'm working hard on refactoring and refining. Hope those of you who're interested could contribute to this project, and enlighten me.</p>

<ul>
<li>[x] Most coding work.</li>
<li>[x] Actor simulation test.</li>
<li>[ ] Snapshot jar.</li>
<li>[ ] Refining and test.</li>
<li>[x] Simple usage description.</li>
<li>[ ] Detailed description.</li>
<li>[ ] Upload javadoc and performance report.</li>
<li>[ ] Release.</li>
</ul>

<h2>
<a id="what-is-psmm" class="anchor" href="#what-is-psmm" aria-hidden="true"><span class="octicon octicon-link"></span></a>What is Psmm?</h2>

<p>Psmm is the abbreviation for PSeudo-Mutable Message. It's a java library for <a href="https://en.wikipedia.org/wiki/Actor_model">actors</a> that allows for creating and accessing immutable messages as if they were mutable ones.</p>

<p>Messages are passed on from actors to actors, thus probably shared by threads. <a href="http://akka.io/">Akka</a> document clearly states that messages must be immutable, otherwise Akka actors can't ensure eliminating evils of low level java concurrency. But for writing immutable object, you need to be careful about things. In this note, I wrote Psmm, so we can easily generate immutable message.</p>

<h2>
<a id="getting-started" class="anchor" href="#getting-started" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting started:</h2>

<p>First needing to initiate PsmmSystem:</p>

<div class="highlight highlight-java"><pre>        <span class="pl-smi">PsmmSystem</span><span class="pl-k">.</span>initiate(); <span class="pl-c">//only invoke once in your main thread</span></pre></div>

<p>Creating a new message</p>

<div class="highlight highlight-java"><pre>        <span class="pl-smi">UMessage</span> message <span class="pl-k">=</span> 
                <span class="pl-smi">Messages</span><span class="pl-k">.</span>create() <span class="pl-c">//create a raw message</span>
                .set(key1, value1) 
                .set(key2, value2) <span class="pl-c">//add some data</span>
                <span class="pl-c1">...</span>
                .cook(); </pre></div>

<p>Modifying an existed one:</p>

<div class="highlight highlight-java"><pre>        <span class="pl-smi">UMessage</span> messageAfter <span class="pl-k">=</span> 
                messageBefore 
                .set(key1, value1) 
                .set(key2, value2) <span class="pl-c">//add or reset some data</span>
                <span class="pl-c1">...</span>
                .cook(); </pre></div>

<p>Regressing a message:</p>

<div class="highlight highlight-java"><pre>        <span class="pl-k">try</span> {
            <span class="pl-smi">UMessage</span> message3<span class="pl-k">=</span>message2<span class="pl-k">.</span>regress();
        } <span class="pl-k">catch</span> (<span class="pl-smi">PsmmCannotRegressExeption</span> e) {
            <span class="pl-c">//tell actor message only has one level</span>
        }</pre></div>

<p>Regression is very useful when actors work in pipeline, e.g. actor can simply check and regress a message to redo rather than resend one. </p>

<p>Code example:</p>

<div class="highlight highlight-java"><pre><span class="pl-k">import</span> <span class="pl-smi">cuz.my.psmm.Messages</span>;
<span class="pl-k">import</span> <span class="pl-smi">cuz.my.psmm.PsmmSystem</span>;
<span class="pl-k">import</span> <span class="pl-smi">cuz.my.psmm.UMessage</span>;

<span class="pl-k">class</span> <span class="pl-en">SimpleTest</span> {

    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">main</span>(<span class="pl-k">String</span>[] <span class="pl-v">args</span>) {
        <span class="pl-c">// TODO Auto-generated method stub</span>

        <span class="pl-smi">PsmmSystem</span><span class="pl-k">.</span>initiate(); <span class="pl-c">//only invoke once in your main thread</span>


        <span class="pl-c">//create a new message:</span>
        <span class="pl-smi">String</span> key1 <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>int1<span class="pl-pds">"</span></span>;
        <span class="pl-smi">String</span> key2 <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>int2<span class="pl-pds">"</span></span>;
        <span class="pl-smi">String</span> key3 <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>str1<span class="pl-pds">"</span></span>;
        <span class="pl-smi">UMessage</span> message1 <span class="pl-k">=</span> 
                <span class="pl-smi">Messages</span><span class="pl-k">.</span>create() <span class="pl-c">//create a raw message</span>
                .set(key1, <span class="pl-c1">2</span>)
                .set(key2, <span class="pl-c1">122</span>)
                .set(key3, <span class="pl-s"><span class="pl-pds">"</span>this is string<span class="pl-pds">"</span></span>) <span class="pl-c">//add some data</span>
                .cook(); <span class="pl-c">//without cook() compile time error.</span>
        <span class="pl-c">//after passed to another actor, fetch data:</span>
        <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(message1<span class="pl-k">.</span>get(key1) 
                <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span> <span class="pl-k">+</span> message1<span class="pl-k">.</span>get(key2) 
                <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span> <span class="pl-k">+</span> message1<span class="pl-k">.</span>get(key3));
        <span class="pl-c">//result: 2|122|this is string</span>

        <span class="pl-smi">String</span> key4 <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>double1<span class="pl-pds">"</span></span>;
        <span class="pl-c">//"modify" last message, reset some data, add some new data:</span>
        <span class="pl-smi">UMessage</span> message2 <span class="pl-k">=</span>
                message1
                .set(key2, <span class="pl-c1">45</span>)
                .set(key3, <span class="pl-s"><span class="pl-pds">"</span>this is another string<span class="pl-pds">"</span></span>)
                .set(key4, <span class="pl-c1">568.3d</span>)
                .cook();
        <span class="pl-c">//after passed to another actor, fetch data:</span>
        <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(message2<span class="pl-k">.</span>get(key1) 
                <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span> <span class="pl-k">+</span> message2<span class="pl-k">.</span>get(key2) 
                <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span> <span class="pl-k">+</span> message2<span class="pl-k">.</span>get(key3)
                <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span> <span class="pl-k">+</span> message2<span class="pl-k">.</span>get(key4));
        <span class="pl-c">//result: 2|45|this is another string|568.3</span>

        <span class="pl-smi">UMessage</span> message3 <span class="pl-k">=</span> <span class="pl-c1">null</span>;
        <span class="pl-k">try</span> {
            message3<span class="pl-k">=</span>message2<span class="pl-k">.</span>regress();
        } <span class="pl-k">catch</span> (<span class="pl-smi">PsmmCannotRegressExeption</span> e) {
            e<span class="pl-k">.</span>printStackTrace();
        }
        <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(message3<span class="pl-k">.</span>get(key1) 
                <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span> <span class="pl-k">+</span> message3<span class="pl-k">.</span>get(key2) 
                <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span> <span class="pl-k">+</span> message3<span class="pl-k">.</span>get(key3)
                <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span> <span class="pl-k">+</span> message3<span class="pl-k">.</span>get(key4));
        <span class="pl-c">//result: 2|122|this is string|null</span>
    }

}</pre></div>

<p>Using typed message (others are the same):</p>

<div class="highlight highlight-java"><pre>        <span class="pl-k">TMessage&lt;<span class="pl-smi">Integer</span>&gt;</span> message2<span class="pl-k">=</span>
                <span class="pl-smi">Messages</span><span class="pl-k">.</span>create(<span class="pl-smi">Integer</span><span class="pl-k">.</span>class)
                .set(<span class="pl-s"><span class="pl-pds">"</span>key1<span class="pl-pds">"</span></span>, <span class="pl-c1">583</span>)
                <span class="pl-c">//.set("key2", "string value") //compile time error</span>
                .cook();</pre></div>

<p><em>NOTE:When use typed message, you must ensure type's immutability.</em></p>

<h2>
<a id="document" class="anchor" href="#document" aria-hidden="true"><span class="octicon octicon-link"></span></a>Document</h2>

<h4>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h4>

<p>Psmm messages take advantage of Decorator Pattern. Every message has a reference of preceded message. For newly created message, PsmmFactory puts a RootMessage in it. After a message has been set("modified"), factory create a new message decorating the old one, of course, with new data. Therefore, you can access psmm as if it were mutable.</p>

<p><em>For class info, please see source file.</em></p>

<h4>
<a id="styles" class="anchor" href="#styles" aria-hidden="true"><span class="octicon octicon-link"></span></a>Styles</h4>

<p>Psmm includes different *Styles of messages standing for different structures.</p>

<p>A1. <strong>Linked</strong>(default): decorate old message when every setting. When getting data, first check keys in newest message, then the last one. This is the fast way to create new object, because when you create it, you don't care about the old data.But when the chain is long, it'll be slower to fetch some data. It also provides a way to regress a message: shell the outermost message, return the inner one.</p>

<p>A2. <strong>Flat</strong>: no decoration, read data from old message and merge them into new message.</p>

<p>B1. Typed: need to explicitly indicate Generic parameter Type. Thus gives flexibility to put user defined data object into message.</p>

<p>B2. <strong>Untyped</strong>: only takes basic immutable object, such as String, Integer etc. When retrieving data, need to cast.</p>

<p>C. Retained(deprecated): references of messages created are stored in a pool. Why not reuse immutable object? (<em>But there might be a pitfall, is it really necessary to retain small object in modern JVM? Generally speaking, this is a bad idea and likely to cause other undesirable potential problems. For now I deprecated this feature. All message will be newly created.</em>)</p>

<p>D1. <strong>Value</strong> (not available now): One message equals another depending on their values.</p>

<p>D2. <strong>Unique</strong> (default): No override to equals() method, message only equals itself.</p>

<p><em>The word *Style is used for distinguishing from Parameter Type.</em></p>

<p>How to choose style:</p>

<div class="highlight highlight-java"><pre><span class="pl-smi">Messages</span><span class="pl-k">.</span>create(<span class="pl-smi">Messages</span><span class="pl-k">.</span><span class="pl-smi">Style</span><span class="pl-c1"><span class="pl-k">.</span>FLAT_MAP</span>)</pre></div>

<h4>
<a id="raw-message-and-factory-model" class="anchor" href="#raw-message-and-factory-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Raw Message and Factory model</h4>

<ul>
<li>
<strong>Raw Message</strong> is a concept helper class which is exposed to user instead of a factory, and to ensure message is actually created. It's a <a href="https://en.wikipedia.org/wiki/Proxy_pattern">Proxy</a> of a factory. Consider situation below:</li>
</ul>

<div class="highlight highlight-java"><pre><span class="pl-smi">UMessage</span> message2 <span class="pl-k">=</span>
        message1
        .set(key2, <span class="pl-c1">45</span>)  <span class="pl-c">//when first call set(), it turns to a raw message</span>
        .set(key3, <span class="pl-s"><span class="pl-pds">"</span>this is another string<span class="pl-pds">"</span></span>)
        .set(key4, <span class="pl-c1">568.3d</span>)
        <span class="pl-c">//.cook(); //no message is really created. Type mismatch, compile time error.</span></pre></div>

<p>A raw message cannot evaluate to UMessage. Also, in concept, it's better than return a factory object.
There are two interfaces of raw message: UntypedRawMessage, TypedRawMessage</p>

<p><em>It's not necessary to grab a raw message's reference in most cases.</em></p>

<ul>
<li>
<strong>Factory</strong> do the real job to store user data and create message. It utilizes the <a href="https://en.wikipedia.org/wiki/Builder_pattern">Builder Pattern</a>. Factory has a final reference of raw message, which means they're paired when their instance are created. The reason to do so is because only factories are store in Factory Pool.</li>
</ul>

<h4>
<a id="factory-detail" class="anchor" href="#factory-detail" aria-hidden="true"><span class="octicon octicon-link"></span></a>Factory detail</h4>

<ul>
<li>
<strong>Module</strong> is factory's component class, does concrete job inside factory. In this <a href="https://en.wikipedia.org/wiki/Strategy_pattern">Strategy Pattern</a>, same factory can be used to create different styles of message. Modules are thread safe or state less, so several factories are able to assemble same Module instances.</li>
</ul>

<p>There are three kinds of Modules:
1. Creation: creates concrete message, like CachedMessage or UncachedMessage.
2. Data: designates Data implementation into factory, like HashMap.
3. Structure: decides which style, like Flat or Linked.</p>

<p>Modules work in combine, taking advantage of <a href="https://en.wikipedia.org/wiki/Decorator_pattern">Decorator Pattern</a>.</p>

<ul>
<li>
<strong>Factory Pool</strong> stores created factories in it. The concrete factory pool MapFactoryPool implements a ConcurrentHashMap. Since thread id is unique (at one time in one JVM), fetching factory in actors is efficient(See tests below). When fetching factory, module is assembled into factory according to message's style. </li>
</ul>

<p><strong>1. with factory pooled:(10 rounds)</strong></p>

<table>
<thead>
<tr>
<th>Benchmark</th>
<th>Mode</th>
<th>Cnt</th>
<th>Score</th>
<th>Error</th>
<th>Units</th>
</tr>
</thead>
<tbody>
<tr>
<td>testCreateControlMessage</td>
<td>avgt</td>
<td>10</td>
<td>235.594</td>
<td>± 0.153</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateTypedFlat</td>
<td>avgt</td>
<td>10</td>
<td>236.712</td>
<td>± 3.648</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateTypedLinked</td>
<td>avgt</td>
<td>10</td>
<td>201.881</td>
<td>± 1.246</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateUntypedFlat</td>
<td>avgt</td>
<td>10</td>
<td>229.547</td>
<td>± 2.261</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateUntypedLinked</td>
<td>avgt</td>
<td>10</td>
<td>186.735</td>
<td>± 1.462</td>
<td>ns/op</td>
</tr>
</tbody>
</table>

<p><strong>2. with factory pooled:(20 rounds)</strong></p>

<table>
<thead>
<tr>
<th>Benchmark</th>
<th>Mode</th>
<th>Cnt</th>
<th>Score</th>
<th>Error</th>
<th>Units</th>
</tr>
</thead>
<tbody>
<tr>
<td>testCreateControlMessage</td>
<td>avgt</td>
<td>20</td>
<td>235.448</td>
<td>± 0.094</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateTypedFlat</td>
<td>avgt</td>
<td>20</td>
<td>168.050</td>
<td>± 1.087</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateTypedLinked</td>
<td>avgt</td>
<td>20</td>
<td>213.511</td>
<td>± 2.694</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateUntypedFlat</td>
<td>avgt</td>
<td>20</td>
<td>191.293</td>
<td>± 0.881</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateUntypedLinked</td>
<td>avgt</td>
<td>20</td>
<td>181.576</td>
<td>± 0.567</td>
<td>ns/op</td>
</tr>
</tbody>
</table>

<p><strong>3. creating new factory</strong>(20 round tests are approximately the same)</p>

<table>
<thead>
<tr>
<th>Benchmark</th>
<th>Mode</th>
<th>Cnt</th>
<th>Score</th>
<th>Error</th>
<th>Units</th>
</tr>
</thead>
<tbody>
<tr>
<td>testCreateControlMessage</td>
<td>avgt</td>
<td>10</td>
<td>237.776</td>
<td>± 0.188</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateTypedFlat</td>
<td>avgt</td>
<td>10</td>
<td>213.812</td>
<td>± 1.271</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateTypedLinked</td>
<td>avgt</td>
<td>10</td>
<td>212.814</td>
<td>± 0.105</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateUntypedFlat</td>
<td>avgt</td>
<td>10</td>
<td>213.675</td>
<td>± 2.062</td>
<td>ns/op</td>
</tr>
<tr>
<td>testCreateUntypedLinked</td>
<td>avgt</td>
<td>10</td>
<td>212.700</td>
<td>± 0.143</td>
<td>ns/op</td>
</tr>
</tbody>
</table>

<p><em>Tested with jmh: 10-20 warmups, 10-20 rounds, 8 threads. Tests simple create a new message and set a pair of random key and Integer. Control message(immutable) is created via two Maps, one as temporary data vehicle when creating, another as data field. HW: xeon E3 1230v2, 16G DDR3 1600. OS: Windows, Oracle JDK 1.8.0_51. See source file for more detail.</em></p>

<ul>
<li>
<strong>Data</strong> class to encapsulate concrete data store strategy. Now, there's only MapData that implements HashMap. Factory has a Data inside, when create message, it give that Data to message and ditch the Data's reference.</li>
</ul>

<h4>
<a id="psmmsystem-and-helper-messages" class="anchor" href="#psmmsystem-and-helper-messages" aria-hidden="true"><span class="octicon octicon-link"></span></a>PsmmSystem and helper Messages</h4>

<ul>
<li>
<strong>PsmmSystem</strong> holds instances of factory pool, message pool and initiate Modules, internally provide static methods.  Instantiating Module at runtime gives more flexibility.</li>
<li>
<strong>Messages</strong> provides factory methods to create message.</li>
</ul>

<h4>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuration</h4>

<p>Psmm provides a class PsmmConfiguration to do some custom setup when initiation. Later I shall probably provide way to customize factory Module and Data through configuration.</p>

<p>How to setup:</p>

<div class="highlight highlight-java"><pre><span class="pl-smi">PsmmConfiguration</span> config<span class="pl-k">=</span><span class="pl-k">new</span> <span class="pl-smi">PsmmConfiguration</span>()
            .setFactoryPoolChoseType(<span class="pl-smi">FactoryPoolType</span><span class="pl-c1"><span class="pl-k">.</span>NULL</span>) <span class="pl-c">//no factory pooling</span>
            <span class="pl-c1">...</span>
<span class="pl-smi">PsmmSystem</span><span class="pl-k">.</span>initiate(config);</pre></div>

<h4>
<a id="performance" class="anchor" href="#performance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Performance</h4>

<p>I've prepared some performance test data, and I'll upload them, and explain in detail.</p>

<p>It's very important to know that generating message, in most cases, only takes a fraction of application time. Sometimes, it's really not necessary to worry about their performance. When I did micro-benchmark test, yeah, disparity could be huge. However, when I did actual actor interaction test, performances are in the same scale.</p>

<h4>
<a id="javadoc" class="anchor" href="#javadoc" aria-hidden="true"><span class="octicon octicon-link"></span></a>Javadoc</h4>

<p>I have written complete javadoc.</p>

<h2>
<a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true"><span class="octicon octicon-link"></span></a>Support or Contact</h2>

<p>Authors:Cause Chung (<a href="https://github.com/cuzfrog" class="user-mention">@cuzfrog</a>)</p>

<p>Any problem, please hit me on GitHub or mail me: <a href="mailto:cuzfrog@139.com">cuzfrog@139.com</a> / <a href="mailto:cuzfrog@gamil.com">cuzfrog@gamil.com</a></p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>The MIT License (MIT)</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Psmm maintained by <a href="https://github.com/cuzfrog">cuzfrog</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-67181335-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
